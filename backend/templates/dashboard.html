<!DOCTYPE html>
<html>
<head>
    <title>X3DH Dashboard</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        h2 { margin-top: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #eee; }
    </style>
</head>
<body>

<h1>X3DH Dashboard</h1>

<h2>Users</h2>
<table id="users-table">
    <tr>
        <th>Username</th>
        <th>Identity Key</th>
        <th>Signed Prekey</th>
        <th>SPK Signature</th>
    </tr>
</table>

<h2>Prekeys</h2>
<table id="prekeys-table">
    <tr>
        <th>Username</th>
        <th>OPK</th>
    </tr>
</table>

<h2>Pending Messages</h2>
<table id="pending-table">
    <tr>
        <th>Receiver</th>
        <th>Count</th>
    </tr>
</table>

<h2>Recent Messages</h2>
<ul id="recent-list"></ul>

<script>
async function loadDashboard() {
    const response = await fetch("/api/dashboard-data");
    const data = await response.json();

    // USERS
    const usersTable = document.getElementById("users-table");
    usersTable.innerHTML = `
        <tr>
            <th>Username</th>
            <th>Identity Key</th>
            <th>Signed Prekey</th>
            <th>SPK Signature</th>
        </tr>`;
    data.users.forEach(u => {
        usersTable.innerHTML += `
            <tr>
                <td>${u.username}</td>
                <td>${u.ik}</td>
                <td>${u.spk}</td>
                <td>${u.sig}</td>
            </tr>`;
    });

    // PREKEYS
    const prekeysTable = document.getElementById("prekeys-table");
    prekeysTable.innerHTML = `
        <tr>
            <th>Username</th>
            <th>OPK</th>
        </tr>`;
    data.prekeys.forEach(p => {
        prekeysTable.innerHTML += `
            <tr>
                <td>${p.username}</td>
                <td>${p.opk}</td>
            </tr>`;
    });

    // PENDING
    const pendingTable = document.getElementById("pending-table");
    pendingTable.innerHTML = `
        <tr>
            <th>Receiver</th>
            <th>Count</th>
        </tr>`;
    data.pending.forEach(p => {
        pendingTable.innerHTML += `
            <tr>
                <td>${p.receiver}</td>
                <td>${p.count}</td>
            </tr>`;
    });

    // RECENT MESSAGES
    const recentList = document.getElementById("recent-list");
    recentList.innerHTML = "";
    data.recent.forEach(msg => {
        recentList.innerHTML += `
            <li>[${msg.timestamp}] From ${msg.sender} to ${msg.receiver} (msg id: ${msg.id}): ${msg.payload}</li>`;
    });
}

// Refresh every 3 seconds
loadDashboard();
setInterval(loadDashboard, 3000);
</script>

</body>
</html>
